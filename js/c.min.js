var activityIndicatorOff,activityIndicatorOn,adminParams,animateLoad,byteCount,deferCalPhotos,delay,formatScientificNames,formatSearchResults,getFilters,goTo,isBlank,isBool,isEmpty,isJson,isNull,isNumber,lightboxImages,loadAdminUi,mapNewWindows,modalTaxon,openLink,openTab,overlayOff,overlayOn,parseTaxonYear,performSearch,prepURI,randomInt,root,roundNumber,searchParams,setHistory,sortResults,stopLoad,stopLoadError,toFloat,toInt,toastStatusMessage,uri,__slice=[].slice;adminParams=new Object();adminParams.loginPage="admin-login.php";adminParams.apiTarget="admin_api.php";loadAdminUi=function(){return false};$(function(){if(window.loadAdminUi===true){return loadAdminUi()}});root=typeof exports!=="undefined"&&exports!==null?exports:this;uri=new Object();uri.o=$.url();uri.urlString=uri.o.attr("protocol")+"://"+uri.o.attr("host")+uri.o.attr("directory");uri.query=uri.o.attr("fragment");isBool=function(a){return a===true||a===false};isEmpty=function(a){return !a||a.length===0};isBlank=function(a){return !a||/^\s*$/.test(a)};isNull=function(b){try{if(isEmpty(b)||isBlank(b)||(b==null)){if(!(b===false||b===0)){return true}}}catch(a){}return false};isJson=function(b){if(typeof b==="object"){return true}try{JSON.parse(b);return true}catch(a){}return false};isNumber=function(a){return !isNaN(parseFloat(a))&&isFinite(a)};toFloat=function(a){if(!isNumber(a)||isNull(a)){return 0}return parseFloat(a)};toInt=function(a){if(!isNumber(a)||isNull(a)){return 0}return parseInt(a)};function toObject(a){var c={};for(var b=0;b<a.length;++b){if(a[b]!==undefined){c[b]=a[b]}}return c}String.prototype.toBool=function(){return this.toString()==="true"};Boolean.prototype.toBool=function(){return this.toString()==="true"};Number.prototype.toBool=function(){return this===1};Object.size=function(c){var b,a;a=0;for(b in c){if(c.hasOwnProperty(b)){a++}}return a};delay=function(a,b){return setTimeout(b,a)};roundNumber=function(b,c){var a;if(c==null){c=0}a=Math.pow(10,c);return Math.round(b*a)/a};jQuery.fn.exists=function(){return jQuery(this).length>0};jQuery.fn.polymerSelected=function(d){var a,f,b,c,i,h;if(d==null){d=void 0}if(d!=null){if(!isBool(d)){try{a=$(this).find("[valueattr]");if(isNull(a)){a=$(this)}i=a.attr("valueattr");c=$(this).find("["+i+"="+d+"]");b=c.index();return c.parent().prop("selected",b)}catch(g){f=g;return false}}else{console.log("setSelected "+d+" is boolean");$(this).parent().children().removeAttribute("selected");$(this).parent().children().removeAttribute("active");$(this).parent().children().removeClass("core-selected");$(this).prop("selected",d);$(this).prop("active",d);if(d===true){return $(this).addClass("core-selected")}}}else{h=void 0;try{a=$(this).find("[valueattr]");if(isNull(a)){a=$(this)}i=a.attr("valueattr");h=$(this).find(".core-selected").attr(i)}catch(g){f=g;return false}if(h==="null"||(h==null)){h=void 0}return h}};jQuery.fn.polymerChecked=function(a){var b;if(a==null){a=void 0}if(a!=null){return jQuery(this).prop("checked",a)}else{b=jQuery(this)[0].checked;if(b==="null"||(b==null)){b=void 0}return b}};jQuery.fn.isVisible=function(){return jQuery(this).css("display")!=="none"};jQuery.fn.hasChildren=function(){return Object.size(jQuery(this).children())>3};byteCount=(function(a){return function(b){return encodeURI(b).split(/%..|./).length-1}})(this);function shuffle(d){for(var b,a,c=d.length;c;b=Math.floor(Math.random()*c),a=d[--c],d[c]=d[b],d[b]=a){}return d}randomInt=function(b,c){var e,d,a;if(b==null){b=0}if(c==null){c=1}e=Math.random();if(b==null){d=[0,b],b=d[0],c=d[1]}if(b>c){a=[c,b],b=a[0],c=a[1]}return Math.floor(e*(c-b+1)+b)};window.debounce_timer=null;({debounce:function(c,a,b){if(a==null){a=300}if(b==null){b=false}return function(){var e,d,f;e=1<=arguments.length?__slice.call(arguments,0):[];f=this;d=function(){if(!b){return c.apply(f,e)}};if(window.debounce_timer!=null){clearTimeout(window.debounce_timer)}else{if(b){c.apply(f,e)}}return window.debounce_timer=setTimeout(d,a)}}});Function.prototype.debounce=function(){var d,c,h,b,f,a,g;a=arguments[0],b=arguments[1],g=arguments[2],d=4<=arguments.length?__slice.call(arguments,3):[];if(a==null){a=300}if(b==null){b=false}if(g==null){g=window.debounce_timer}f=this;c=function(){if(!b){f.apply(f,d)}return console.log("Debounce applied")};if(g!=null){try{clearTimeout(g)}catch(i){h=i}}else{if(b){f.apply(obj,d);console.log("Executed immediately")}}return window.debounce_timer=setTimeout(c,a)};mapNewWindows=function(){return $(".newwindow").each(function(){var a,b;a=$(this).attr("href");if(a==null){a=$(this).attr("data-href")}b=function(c){if(c==null){return false}window.open(c);return false};$(this).click(function(){return b(a)});return $(this).keypress(function(){return b(a)})})};toastStatusMessage=function(d,c,e,a){var b;if(c==null){c="error"}if(e==null){e=3000}if(a==null){a="#status-message"}if(!isNumber(e)){e=3000}if(a.slice(0,1)===!"#"){a="#"+a}if(!$(a).exists()){b='<paper-toast id="'+(a.slice(1))+'" duration="'+e+'"></paper-toast>';$(b).appendTo("body")}$(a).attr("text",d);$(a).addClass(c);$(a)[0].show();return delay(e+500,function(){$(a).empty();$(a).removeClass(c);return $(a).attr("text","")})};openLink=function(a){if(a==null){return false}window.open(a);return false};openTab=function(a){return openLink(a)};goTo=function(a){if(a==null){return false}window.location.href=a;return false};animateLoad=function(g,b){var c,a;if(g==null){g=50}if(b==null){b="loader"}if(b.slice(0,1)==="#"){a=b;b=b.slice(1)}else{a="#"+b}try{if(!$(a).exists()){$("body").append('<paper-spinner id="'+b+'" active></paper-spinner')}else{$(a).attr("active",true)}return false}catch(f){c=f;return console.log("Could not animate loader",c.message)}};stopLoad=function(b){var c,a;if(b==null){b="loader"}if(b.slice(0,1)==="#"){a=b;b=b.slice(1)}else{a="#"+b}try{if($(a).exists()){$(a).addClass("good");return delay(1000,function(){$(a).removeClass("good");return $(a).attr("active",false)})}}catch(d){c=d;return console.log("Could not stop load animation",c.message)}};stopLoadError=function(b){var c,a;if(b==null){b="loader"}if(b.slice(0,1)==="#"){a=b;b=b.slice(1)}else{a="#"+b}try{if($(a).exists()){$(a).addClass("bad");return delay(3000,function(){$(a).removeClass("bad");return $(a).attr("active",false)})}}catch(d){c=d;return console.log("Could not stop load error animation",c.message)}};lightboxImages=function(a){var b;if(a==null){a=".lightboximage"}b={onStart:function(){return overlayOn()},onEnd:function(){overlayOff();return activityIndicatorOff()},onLoadStart:function(){return activityIndicatorOn()},onLoadEnd:function(){return activityIndicatorOff()},allowedTypes:"png|jpg|jpeg|gif"};return $(a).imageLightbox(b)};activityIndicatorOn=function(){return $('<div id="imagelightbox-loading"><div></div></div>').appendTo("body")};activityIndicatorOff=function(){return $("#imagelightbox-loading").remove()};overlayOn=function(){return $('<div id="imagelightbox-overlay"></div>').appendTo("body")};overlayOff=function(){return $("#imagelightbox-overlay").remove()};formatScientificNames=function(a){if(a==null){a=".sciname"}return $(".sciname").each(function(){var b;b=$(this).css("font-style")==="italic"?"normal":"italic";return $(this).css("font-style",b)})};prepURI=function(a){a=encodeURIComponent(a);return a.replace(/%20/g,"+")};$(function(){$(".click").click(function(){return openTab($(this).attr("data-url"))});return $('[data-toggle="tooltip"]').tooltip()});searchParams=new Object();searchParams.targetApi="commonnames_api.php";searchParams.targetContainer="#result_container";searchParams.apiPath=uri.urlString+searchParams.targetApi;performSearch=function(e){var a,d,c,b;if(e==null){e=void 0}if(e==null){c=$("#search").val();b=c;c=c.toLowerCase();d=getFilters();if((isNull(c)||(c==null))&&isNull(d)){$("#search-status").attr("text","Please enter a search term.");$("#search-status")[0].show();return false}c=prepURI(c);if($("#loose").polymerChecked()){c=""+c+"&loose=true"}if($("#fuzzy").polymerChecked()){c=""+c+"&fuzzy=true"}if(!isNull(d)){console.log("Got filters - "+d);c=""+c+"&filter="+d}a="q="+c}else{if(e===true){a="q=";b="(all items)"}else{a="q="+e;b=e.split("&")[0]}console.log("Searching on "+e)}if(c==="#"||(isNull(c)&&isNull(a))||(a==="q="&&e!==true)){return false}animateLoad();console.log("Got search value "+c+", hitting",""+searchParams.apiPath+"?"+a);return $.get(searchParams.targetApi,a,"json").done(function(f){var j,g,h;console.log("Search executed by "+f.method+" with "+f.count+" results.");if(toInt(f.count)===0){if(f.status===true){if(f.query_params.filter.had_filter===true){j="";g=0;$.each(f.query_params.filter.filter_params,function(i,k){if(i!=="BOOLEAN_TYPE"){if(g!==0){j=""+filter_text+" "+f.filter.filter_params.BOOLEAN_TYPE}return j=""+j+" "+(i.replace(/_/g," "))+" is "+k}});h='"'+b+'" where '+j+" returned no results."}else{h='"'+b+'" returned no results.'}}else{h=f.human_error}$("#search-status").attr("text",h);$("#search-status")[0].show();stopLoadError();return false}if(f.status===true){formatSearchResults(f);return false}$("#search-status").attr("text",f.human_error);$("#search-status")[0].show();console.error(f.error);console.warn(f);return stopLoadError()}).fail(function(f,g){console.error("There was an error performing the search");console.warn(f,g,f.statusText);g=""+f.status+" - "+f.statusText;$("#search-status").attr("text","Couldn't execute the search - "+g);$("#search-status")[0].show();return stopLoadError()}).always(function(){var f;f=Base64.encodeURI(c);if(c!=null){setHistory(""+uri.urlString+"#"+f)}return false})};getFilters=function(a,h){var f,c,d,b;if(a==null){a=".cndb-filter"}if(h==null){h="AND"}d=new Object();$(a).each(function(){var e,i;e=$(this).attr("data-column");if(e==null){return true}i=$(this).polymerSelected();if(i==="any"||i==="all"||i==="*"){return true}if(isNull(i)||i===false){i=$(this).val();if(isNull(i)){return true}else{}}return d[e]=i.toLowerCase()});if(Object.size(d)===0){console.log("Got back an empty filter list.");return""}try{d.BOOLEAN_TYPE=h;b=JSON.stringify(d);c=Base64.encodeURI(b);console.log("Returning "+c+" from",d);return c}catch(g){f=g;return false}};formatSearchResults=function(j,a){var g,i,f,c,h,d,e,b;if(a==null){a=searchParams.targetContainer}f=j.result;searchParams.result=f;c=new Array();h="";e="<table id='cndb-result-list' class='table table-striped table-hover'>\n\t<tr class='cndb-row-headers'>";d="</table>";b=toInt(j.count)-1;i=null;g=0;return $.each(f,function(o,q){var p,m,k,n;if(toInt(o)===0){m=0;e+="\n<!-- Table Headers - "+(Object.size(q))+" entries -->";$.each(q,function(r,l){var t,u,s;s=r.replace(/_/g," ");if(r!=="id"&&r!=="minor_type"&&r!=="notes"){if($("#show-deprecated").polymerSelected()!==true){t="deprecated_scientific"}else{t=""}if(r!==t){e+="\n\t\t<th class='text-center'>"+s+"</th>";g++}}m++;if(m===Object.size(q)){e+="\n\t</tr>";e+="\n<!-- End Table Headers -->";console.log("Got "+g+" display columns.");u=roundNumber(12/g,0);return i="col-md-"+u}})}n=""+q.genus+"+"+q.species;if(!isNull(q.subspecies)){n=""+n+"+"+q.subspecies}p="\n\t<tr id='cndb-row"+o+"' class='cndb-result-entry' data-taxon=\""+n+'">';k=0;$.each(q,function(r,l){var s,u,t,z,y,A,w,v;if(r!=="id"&&r!=="minor_type"&&r!=="notes"){if(r==="authority_year"){try{try{u=JSON.parse(l)}catch(x){t=x;console.warn("There was an error parsing '"+l+"', attempting to fix - ",t.message);w=l.split(":");v=w[1].slice(w[1].search('"')+1,-2);console.log("Examining "+v);v=v.replace(/"/g,"'");w[1]='"'+v+'"}';l=w.join(":");console.log("Reconstructed "+l);u=JSON.parse(l)}z=Object.keys(u)[0];A=u[z];l="G: "+z+"<br/>S: "+A}catch(x){t=x;console.error("There was an error parsing '"+l+"'",t.message);u=l}}if($("#show-deprecated").polymerSelected()!==true){s="deprecated_scientific"}else{s=""}if(r!==s){if(r==="image"){if(isNull(l)){l="<paper-icon-button icon='launch' data-href='http://calphotos.berkeley.edu/cgi/img_query?rel-taxon=contains&where-taxon="+n+"' class='newwindow calphoto' data-taxon=\""+n+'"></paper-icon-button>'}else{l="<paper-icon-button icon='image:image' data-lightbox='"+l+"' class='lightboximage'></paper-icon-button>"}}if(r!=="genus"&&r!=="species"&&r!=="subspecies"){y=""+r+" text-center"}else{y=r}p+="\n\t\t<td id='"+r+"-"+o+"' class='"+y+" "+i+"'>"+l+"</td>"}}k++;if(k===Object.size(q)){p+="\n\t</tr>";return h+=p}});if(toInt(o)===b){h=e+h+d;console.log("Processed "+(toInt(o)+1)+" rows");$(a).html(h);mapNewWindows();lightboxImages();modalTaxon();$("#result-count").text(" - "+j.count+" entries");return stopLoad()}})};parseTaxonYear=function(a,h){var c,b,j,k,g,f;if(h==null){h=true}try{c=JSON.parse(a)}catch(i){b=i;console.warn("There was an error parsing '"+a+"', attempting to fix - ",b.message);g=a.split(":");f=g[1].slice(g[1].search('"')+1,-2);console.log("Examining "+f);f=f.replace(/"/g,"'");g[1]='"'+f+'"}';a=g.join(":");console.log("Reconstructed "+a);try{c=JSON.parse(a)}catch(i){b=i;if(h){return false}else{return a}}}j=Object.keys(c)[0];k=c[j];f=new Object();f.genus=j;f.species=k;return f};deferCalPhotos=function(a){var d,c,b;if(a==null){a=".calphoto"}d=$(a).length;c="http://calphotos.berkeley.edu/cgi-bin/img_query";b=0;$(a).each(function(){var f,e,g;b++;g=$(this);e=g.attr("data-taxon");f="getthumbinfo=1&num=all&cconly=1&taxon="+e+"&format=xml";return $.get(c,f).done(function(n){var m,j,k,l,h,i;h=xmlToJSON.parseString(n);m=h.xml.calphotos;i=m.thumb_url;k=m.enlarge_jpeg_url;l=m.enlarge_url;j="<a href='"+k+"' class='calphoto-img-anchor'><img src='"+i+"' data-href='"+l+"' class='calphoto-img-thumb' data-taxon='"+e+"'/></a>";g.replaceWith(j);return false}).fail(function(h,i){return false}).always(function(){if(b===d){return lightboxImages(".calphoto-image-anchor")}})});return false};modalTaxon=function(a){var b;if(a==null){a=void 0}if(a==null){$(".cndb-result-entry").click(function(){return modalTaxon($(this).attr("data-taxon"))});return false}animateLoad();if(!$("#modal-taxon").exists()){b="<paper-action-dialog backdrop layered closeSelector=\"[affirmative]\" id='modal-taxon'><div id='modal-taxon-content'></div><paper-button dismissive id='modal-inat-linkout'>iNaturalist</paper-button><paper-button dismissive id='modal-calphotos-linkout'>CalPhotos</paper-button><paper-button affirmative autofocus>Close</paper-button></paper-action-dialog>";$("#result_container").after(b)}$.get(searchParams.targetApi,"q="+a,"json").done(function(o){var h,c,k,g,j,d,f,l,m;h=o.result[0];console.log("Got",h);l=parseTaxonYear(h.authority_year);m="";if(l!==false){m="<p><span class='genus'>"+h.genus+"</span>, <span class='genus_authority'>"+h.genus_authority+"</span> "+l.genus+"; <span class='species'>"+h.species+"</span>, <span class='species_authority'>"+h.species_authority+"</span> "+l.species+"</p>"}c="";if(!isNull(h.deprecated_scientific)){c="<p>Deprecated names:";try{f=JSON.parse(h.deprecated_scientific);j=0;$.each(f,function(e,i){j++;if(j!==1){c+="; "}c+="<span class='sciname'>"+e+"</span>, "+i;if(j===Object.size(f)){return c+="</p>"}})}catch(n){k=n;c="";console.error("There were deprecated scientific names, but the JSON was malformed.")}}d="";if(!isNull(h.minor_type)){d=" <core-icon icon='arrow-forward'></core-icon> <span id='taxon-minor-type'>"+h.minor_type+"</span>"}if(isNull(h.notes)){h.notes="Sorry, we have no notes on this taxon yet."}b="<div id='meta-taxon-info'>"+m+"<p>Common name: <span id='taxon-common-name' class='common_name'>"+h.common_name+"</span></p><p>Type: <span id='taxon-type'>"+h.major_type+"</span> (<span id='taxon-common-type'>"+h.major_common_type+"</span>) <core-icon icon='arrow-forward'></core-icon> <span id='taxon-subtype'>"+h.major_subtype+"</span>"+d+"</p>"+c+"</div><h3>Taxon Notes</h3><p id='taxon-notes'>"+h.notes+"</p>";$("#modal-taxon-content").html(b);$("#modal-inat-linkout").unbind().click(function(){return openTab("http://www.inaturalist.org/taxa/search?q="+a)});$("#modal-calphotos-linkout").unbind().click(function(){return openTab("http://calphotos.berkeley.edu/cgi/img_query?rel-taxon=contains&where-taxon="+a)});formatScientificNames();g=a.charAt(0).toUpperCase()+a.slice(1);g=g.replace(/\+/g," ");$("#modal-taxon").attr("heading",g);stopLoad();return $("#modal-taxon")[0].open()}).fail(function(c,d){return stopLoadError()});return false};sortResults=function(b){var a;return a=searchParams.result};setHistory=function(a,b,c){if(a==null){a="#"}if(b==null){b=null}if(c==null){c=null}history.pushState(b,c,a);uri.query=$.url(a).attr("fragment");return false};$(function(){var c,a,b,j,g,d,f,h,k;console.log("Doing onloads ...");animateLoad();window.addEventListener("popstate",function(n){var m,l;uri.query=$.url().attr("fragment");m=Base64.decode(uri.query);console.log("Popping state to "+m);performSearch(m);l=m.split("&")[0];return $("#search").attr("value",l)});$("#search_form").submit(function(l){l.preventDefault();return performSearch()});$("#collapse-advanced").on("shown.bs.collapse",function(){return $("#collapse-icon").attr("icon","unfold-less")});$("#collapse-advanced").on("hidden.bs.collapse",function(){return $("#collapse-icon").attr("icon","unfold-more")});$("#search_form").keypress(function(l){if(l.which===13){return performSearch()}});$("#do-search").click(function(){return performSearch()});$("#do-search-all").click(function(){return performSearch(true)});if(isNull(uri.query)){g=""}else{try{g=Base64.decode(uri.query);h=$.url(""+searchParams.apiPath+"?q="+g);try{d=h.param("loose").toBool()}catch(i){c=i;d=false}try{j=h.param("fuzzy").toBool()}catch(i){c=i;j=false}$("#loose").prop("checked",d);$("#fuzzy").prop("checked",j);k=g.split("&")[0];$("#search").attr("value",k);try{a=h.param("filter");b=JSON.parse(Base64.decode(a));f=false;$.each(b,function(l,m){var e;l=l.replace(/_/g,"-");e="#"+l+"-filter";if(l!=="type"){$(e).attr("value",m);return f=true}else{return $("#linnean-order").polymerSelected(m)}});if(f){$("#collapse-advanced").collapse("show")}}catch(i){c=i;a=false}}catch(i){c=i;console.error("Bad argument "+uri.query+" => "+g+", looseState, fuzzyState",d,j,""+searchParams.apiPath+"?q="+g);console.warn(c.message);g=""}}if(!isNull(g)&&g!=="#"){console.log("Doing initial search with '"+g+"', hitting",""+searchParams.apiPath+"?q="+g);return $.get(searchParams.targetApi,"q="+g,"json").done(function(e){if(e.status===true&&e.count>0){console.log("Got a valid result, formatting "+e.count+" results.");formatSearchResults(e);return false}if(e.count===0){e.human_error='No results for "'+(g.split("&")[0])+'"'}$("#search-status").attr("text",e.human_error);$("#search-status")[0].show();console.error(e.error);console.warn(e);return stopLoadError()}).fail(function(e,l){console.error("There was an error loading the generic table");console.warn(e,l,e.statusText);l=""+e.status+" - "+e.statusText;$("#search-status").attr("text","Couldn't load table - "+l);$("#search-status")[0].show();return stopLoadError()}).always(function(){$("#search").attr("disabled",false);return false})}else{stopLoad();$("#search").attr("disabled",false);return $("#loose").prop("checked",true)}});